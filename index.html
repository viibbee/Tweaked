<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Генератор твика с Alert и кнопками</title>
<style>
  body { max-width: 600px; margin: auto; font-family: sans-serif; padding: 1em; }
  label { display: block; margin-top: 1em; font-weight: bold; }
  input[type="text"], textarea { width: 100%; padding: 0.5em; font-size: 1em; box-sizing: border-box; }
  input[type="url"] { width: 100%; padding: 0.5em; font-size: 1em; box-sizing: border-box; }
  .btn { margin-top: 1em; padding: 0.7em 1.5em; font-size: 1em; cursor: pointer; }
  .button-row { margin-top: 1em; border: 1px solid #ccc; padding: 0.5em; }
  .button-row > div { margin-bottom: 0.5em; }
  .status { margin-top: 1em; font-weight: bold; }
</style>
</head>
<body>

<h1>Генератор твика с Alert</h1>

<label>GitHub Token:</label>
<input type="password" id="token" placeholder="ghp_..." />

<label>Заголовок Alert (макс 30 символов):</label>
<input type="text" id="title" maxlength="30" placeholder="Приветствие" />

<label>Сообщение Alert:</label>
<textarea id="message" rows="4" placeholder="Текст приветствия..."></textarea>

<label>Кнопки (название и ссылка, максимум 5):</label>

<div id="buttons-container">
  <!-- Кнопки будут вставлены сюда -->
</div>

<button class="btn" id="add-btn" type="button">Добавить кнопку</button>

<button class="btn" onclick="generateAndPush()">Сгенерировать и отправить</button>

<div class="status" id="status"></div>

<script>
  const maxButtons = 5;
  const buttonsContainer = document.getElementById('buttons-container');
  const statusEl = document.getElementById('status');
  const tokenInput = document.getElementById('token');

  function addButtonRow(name='', url='') {
    if (buttonsContainer.children.length >= maxButtons) return;
    const div = document.createElement('div');
    div.className = 'button-row';
    div.innerHTML = `
      <input type="text" placeholder="Название кнопки" class="btn-name" value="${name}" required />
      <input type="url" placeholder="Ссылка кнопки" class="btn-url" value="${url}" required />
      <button type="button" onclick="this.parentNode.remove()">Удалить</button>
    `;
    buttonsContainer.appendChild(div);
  }

  document.getElementById('add-btn').onclick = () => {
    addButtonRow();
  };

  // Изначально 1 кнопка
  addButtonRow();

  function escapeForObjC(str) {
    // Экранируем кавычки и слэши
    return str.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
  }

  function generateTweakXM(title, message, buttons) {
    // Формируем кнопки Obj-C код
    let btnsCode = '';
    buttons.forEach((btn, i) => {
      btnsCode += `
    UIAlertAction *button${i} = [UIAlertAction actionWithTitle:@"${escapeForObjC(btn.name)}"
                                                         style:UIAlertActionStyleDefault
                                                       handler:^(UIAlertAction * _Nonnull action) {
        NSURL *url = [NSURL URLWithString:@"${escapeForObjC(btn.url)}"];
        if ([[UIApplication sharedApplication] canOpenURL:url]) {
            [[UIApplication sharedApplication] openURL:url options:@{} completionHandler:nil];
        }
    }];
    [alert addAction:button${i}];`;
    });

    return `#import <UIKit/UIKit.h>
%hook SpringBoard

- (void)applicationDidFinishLaunching:(UIApplication *)application {
    %orig;

    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"${escapeForObjC(title)}"
                                                                   message:@"${escapeForObjC(message)}"
                                                            preferredStyle:UIAlertControllerStyleAlert];${btnsCode}

    dispatch_async(dispatch_get_main_queue(), ^{
        [[UIApplication sharedApplication].keyWindow.rootViewController presentViewController:alert animated:YES completion:nil];
    });
}

%end
`;
  }

  function generateControlFile() {
    return `Package: com.yourname.tweakalert
Name: Tweak Alert
Version: 1.0
Architecture: iphoneos-arm
Description: Simple alert tweak with buttons
Maintainer: YourName
Author: YourName
Section: Tweaks
Depends: mobilesubstrate
`;
  }

  async function generateAndPush() {
    statusEl.textContent = '';
    const token = tokenInput.value.trim();
    if (!token) {
      statusEl.textContent = 'Введите GitHub Token';
      return;
    }
    const title = document.getElementById('title').value.trim() || 'Приветствие';
    const message = document.getElementById('message').value.trim() || '';
    if (title.length > 30) {
      statusEl.textContent = 'Заголовок не должен быть длиннее 30 символов.';
      return;
    }

    const btnNameEls = document.querySelectorAll('.btn-name');
    const btnUrlEls = document.querySelectorAll('.btn-url');

    let buttons = [];
    for (let i = 0; i < btnNameEls.length; i++) {
      const name = btnNameEls[i].value.trim();
      const url = btnUrlEls[i].value.trim();
      if (name && url) {
        buttons.push({name, url});
      }
    }
    if (buttons.length === 0) {
      statusEl.textContent = 'Добавьте хотя бы одну кнопку с названием и ссылкой.';
      return;
    }
    if (buttons.length > maxButtons) {
      statusEl.textContent = 'Максимум 5 кнопок.';
      return;
    }

    const tweakCode = generateTweakXM(title, message, buttons);
    const controlCode = generateControlFile();

    statusEl.textContent = 'Получаю SHA файлов...';

    // Функция для получения sha файла в репозитории
    async function getSha(filename) {
      const res = await fetch(`https://api.github.com/repos/viibbee/Tweaked/contents/${filename}`, {
        headers: { Authorization: 'token ' + token }
      });
      if (res.ok) {
        const data = await res.json();
        return data.sha;
      }
      return null;
    }

    // Функция для пуша файла
    async function pushFile(filename, content, sha = null) {
      const body = {
        message: `Update ${filename}`,
        content: btoa(unescape(encodeURIComponent(content))),
        branch: "main",
      };
      if (sha) body.sha = sha;
      const res = await fetch(`https://api.github.com/repos/viibbee/Tweaked/contents/${filename}`, {
        method: 'PUT',
        headers: {
          Authorization: 'token ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      return res.ok;
    }

    try {
      const shaTweak = await getSha('Tweak.xm');
      const shaControl = await getSha('control');

      statusEl.textContent = 'Отправляю Tweak.xm...';
      const ok1 = await pushFile('Tweak.xm', tweakCode, shaTweak);

      statusEl.textContent = 'Отправляю control...';
      const ok2 = await pushFile('control', controlCode, shaControl);

      if (ok1 && ok2) {
        statusEl.textContent = '✅ Файлы успешно отправлены! GitHub Actions начнёт сборку в ближайшее время.';
      } else {
        statusEl.textContent = '❌ Ошибка при отправке файлов.';
      }
    } catch (e) {
      statusEl.textContent = '❌ Ошибка: ' + e.message;
    }
  }
</script>

</body>
</html>